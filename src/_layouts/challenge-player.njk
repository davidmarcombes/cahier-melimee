---
layout: base
---

{#
  Challenge Player — Random operation generator.
  Config from front-matter is passed to Alpine.js; operations are generated at runtime.
#}

<div
  x-data='challengePlayer({{ { title: title, operator: operator, operandA: operandA, operandB: operandB, count: count, mode: mode or "" } | dump | safe }})'
  x-cloak class="max-w-xl mx-auto py-8"
>
  {# Header #}
  <div class="flex items-center justify-between mb-4 text-sm">
    <a href="/fr/exercices/" class="text-slate-400 hover:text-primary-500 transition-colors text-lg" aria-label="Retour aux exercices">&#x2B05;&#xFE0F;</a>
    <span class="text-slate-400" x-text="solvedCount + ' / ' + config.count"></span>
  </div>

  {# Progress bar #}
  <div class="w-full h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full mb-6 overflow-hidden">
    <div class="h-full bg-primary-500 rounded-full transition-all duration-500"
         :style="'width:' + Math.round((solvedCount / config.count) * 100) + '%'"></div>
  </div>

  {# Title #}
  <h1 class="text-2xl font-bold text-content-default mb-2 text-center">{{ title }}</h1>

  {# Instructions from markdown body #}
  {% if content | trim %}
  <div class="prose dark:prose-invert text-center text-sm max-w-none mb-6 text-content-subtle">
    {{ content | safe }}
  </div>
  {% endif %}

  {# Operation card #}
  <div x-show="!allDone" class="bg-surface-subtle rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 p-8 mb-8">
    {# Standard mode: operation = ? #}
    <div x-show="!currentOperation.includes('?')" class="text-center">
      <span class="text-5xl font-extrabold text-content-default tracking-wide" x-text="currentOperation + ' = ?'"></span>
    </div>
    {# Trou mode: inline blank #}
    <div x-show="currentOperation.includes('?')" class="flex items-center justify-center gap-2 flex-wrap">
      <span class="text-4xl sm:text-5xl font-extrabold text-content-default tracking-wide whitespace-nowrap"
            x-text="currentOperation.split('?')[0]"></span>
      <input type="text" inputmode="numeric"
             x-model="userInput" @keydown.enter="check()" :disabled="justSolved"
             class="w-16 sm:w-20 h-14 sm:h-16 text-center text-3xl sm:text-4xl font-extrabold
               rounded-xl border-2 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500
               bg-white dark:bg-slate-800 text-content-default"
             :class="{
               'border-green-500 bg-green-50 dark:bg-green-900/20': justSolved,
               'border-red-400 bg-red-50 dark:bg-red-900/20': showError,
               'border-primary-300 dark:border-primary-600': !justSolved && !showError
             }"
             placeholder="?"
             x-ref="trouInput" />
      <span class="text-4xl sm:text-5xl font-extrabold text-content-default tracking-wide whitespace-nowrap"
            x-text="currentOperation.split('?')[1]"></span>
    </div>
  </div>

  {# Trou mode: verify button #}
  <div x-show="!allDone && currentOperation.includes('?')" class="flex justify-center mb-6">
    <button @click="check()" :disabled="justSolved || !userInput.trim()"
      class="px-8 py-3 text-lg font-bold rounded-xl transition-all active:scale-95
        disabled:opacity-40 disabled:cursor-not-allowed"
      :class="justSolved ? 'bg-green-500 text-white' : 'bg-primary-500 text-white hover:bg-primary-600 shadow-md'">
      <span x-show="!justSolved">Vérifier</span>
      <span x-show="justSolved">Bravo !</span>
    </button>
  </div>

  {# Standard mode: answer input + check button #}
  <div x-show="!allDone && !currentOperation.includes('?')" class="flex items-center gap-3 mb-6">
    <input
      type="text" inputmode="numeric"
      x-model="userInput"
      @keydown.enter="check()"
      :disabled="justSolved"
      placeholder="Ta réponse…"
      x-ref="input"
      class="w-full px-4 py-3 text-lg border-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors
        bg-surface-subtle text-content-default
        border-slate-200 dark:border-slate-700"
      :class="{
        'border-green-500 bg-green-50 dark:bg-green-900/20': justSolved,
        'border-red-400 bg-red-50 dark:bg-red-900/20': showError
      }"
    />
    <button
      @click="check()"
      :disabled="justSolved || !userInput.trim()"
      class="shrink-0 px-6 py-3 text-lg font-bold rounded-xl transition-all active:scale-95
        disabled:opacity-40 disabled:cursor-not-allowed"
      :class="justSolved
        ? 'bg-green-500 text-white'
        : 'bg-primary-500 text-white hover:bg-primary-600 shadow-md'"
    >
      <span x-show="!justSolved">Vérifier</span>
      <span x-show="justSolved">Bravo !</span>
    </button>
  </div>

  {# Error feedback #}
  <div
    x-show="showError"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 -translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    class="p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300"
  >
    Ce n'est pas la bonne réponse. Essaie encore !
  </div>

  {# Success feedback #}
  <div
    x-show="justSolved"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100"
    class="p-4 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300 text-center"
  >
    Bonne réponse !
  </div>

  {# Challenge complete #}
  <div
    x-show="allDone"
    x-transition:enter="transition ease-out duration-500"
    x-transition:enter-start="opacity-0 translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    class="mt-6 text-center"
  >
    <div class="p-6 rounded-2xl bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800">
      <p class="text-lg font-bold text-primary-700 dark:text-primary-300 mb-3">Défi terminé !</p>
      <p class="text-sm text-content-subtle mb-4" x-text="solvedCount + '/' + config.count + ' calculs réussis'"></p>
      <div class="flex gap-3 justify-center">
        <button @click="restart()" class="px-6 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-all active:scale-95">
          Recommencer
        </button>
        <a href="/fr/exercices/" class="px-6 py-2 border border-slate-300 dark:border-slate-600 text-content-default rounded-xl hover:bg-surface-subtle transition-all">
          Retour aux exercices
        </a>
      </div>
    </div>
  </div>

  {% include "components/report-form.njk" %}
</div>
