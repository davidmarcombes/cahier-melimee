---
layout: base
---

<div class="max-w-md mx-auto py-12">
  <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white mb-2 text-center">{{ title }}</h1>
  
  {{ content | safe }}

  <div x-data="connexionForm()" x-cloak class="p-8 bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700">

    {# Step 1: Enter slug #}
    <div x-show="step === 1">
      <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ton pseudonyme</label>
      <input
        type="text"
        x-model="slug"
        @keydown.enter="findPupil()"
        placeholder="petit-renard-roux-3"
        class="w-full px-4 py-3 text-lg border-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors
          bg-white dark:bg-slate-900 text-slate-900 dark:text-white border-slate-200 dark:border-slate-700"
      />
      <div x-show="error" class="mt-3 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm" x-text="error"></div>
      <button
        @click="findPupil()"
        :disabled="!slug.trim() || loading"
        class="mt-4 w-full px-6 py-3 bg-primary-500 text-white font-bold rounded-xl hover:bg-primary-600 shadow-md transition-all active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
      >
        Suivant
      </button>
    </div>

    {# Step 2: Visual password #}
    <div x-show="step === 2">
      <p class="text-center text-slate-600 dark:text-slate-400 mb-6">Entre ta clÃ© secrÃ¨te (3 images).</p>

      <div class="flex justify-center gap-4 mb-6">
        <template x-for="i in 3">
          <div
            class="w-14 h-14 border-2 border-dashed rounded-xl flex items-center justify-center text-2xl transition-all cursor-pointer"
            :class="passwordSequence[i-1] ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20 scale-110' : 'border-slate-300 dark:border-slate-600'"
            x-text="passwordSequence[i-1] || '?'"
            @click="removeLastIcon(i-1)"
          ></div>
        </template>
      </div>

      <div class="grid grid-cols-5 gap-3 mb-6">
        <template x-for="icon in icons" :key="icon">
          <button
            @click="addIcon(icon)"
            :disabled="passwordSequence.length >= 3"
            class="aspect-square flex items-center justify-center text-2xl border border-slate-100 dark:border-slate-700 rounded-xl hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all disabled:opacity-30 disabled:cursor-not-allowed active:scale-90"
            x-text="icon"
          ></button>
        </template>
      </div>

      <div x-show="error" class="mb-4 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm" x-text="error"></div>

      <div class="flex gap-3">
        <button @click="step = 1; error = ''; passwordSequence = []" class="px-5 py-3 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">Retour</button>
        <button
          @click="verify()"
          :disabled="passwordSequence.length < 3 || loading"
          class="flex-1 px-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-md transition-all active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
        >
          <span x-show="loading" class="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></span>
          Se connecter
        </button>
      </div>
    </div>

    {# Step 3: Success #}
    <div x-show="step === 3" class="text-center py-4">
      <div class="text-6xl mb-4">ğŸ‘‹</div>
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Content de te revoir !</h2>
      <p class="text-slate-500 dark:text-slate-400 mb-6" x-text="pupilName"></p>
      <a :href="'/cahier/' + slug" class="inline-block px-8 py-3 bg-primary-500 text-white font-bold rounded-xl shadow-md hover:bg-primary-600 transition-all active:scale-95">
        AccÃ©der Ã  mon cahier
      </a>
    </div>
  </div>

  <p class="text-center mt-6 text-sm text-slate-400 dark:text-slate-500">
    Pas encore inscrit ? <a href="/fr/onboarding/" class="text-primary-500 hover:underline">CrÃ©e ton identitÃ©</a>
  </p>
</div>

<script>
function connexionForm() {
  const pb = new PocketBase('http://localhost:8090');
  return {
    step: 1,
    slug: '',
    passwordSequence: [],
    icons: ['ğŸ', 'ğŸŒ', 'ğŸ’', 'ğŸ“', 'ğŸ‡', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸ‰', 'ğŸ‹'],
    error: '',
    loading: false,
    pupilRecord: null,
    pupilName: '',

    async findPupil() {
      this.error = '';
      this.loading = true;
      try {
        const res = await pb.collection('pupils').getList(1, 1, {
          filter: `slug = "${this.slug.trim()}"`
        });
        if (res.items.length === 0) {
          this.error = 'Pseudonyme introuvable. VÃ©rifie l\u2019orthographe.';
        } else {
          this.pupilRecord = res.items[0];
          this.pupilName = this.pupilRecord.username;
          this.step = 2;
        }
      } catch (err) {
        this.error = 'Erreur de connexion au serveur.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    addIcon(icon) {
      if (this.passwordSequence.length < 3) this.passwordSequence.push(icon);
    },

    removeLastIcon(index) {
      if (index === this.passwordSequence.length - 1) this.passwordSequence.pop();
    },

    async verify() {
      this.error = '';
      this.loading = true;
      try {
        const entered = this.passwordSequence.join('-');
        if (entered === this.pupilRecord.visual_key) {
          this.step = 3;
        } else {
          this.error = 'ClÃ© secrÃ¨te incorrecte. Essaie encore.';
          this.passwordSequence = [];
        }
      } catch (err) {
        this.error = 'Erreur de vÃ©rification.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    }
  };
}
</script>
