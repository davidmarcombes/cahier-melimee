---
layout: base
needsPocketBase: true
---

<div class="max-w-md mx-auto py-12">
  <h1 class="text-3xl font-extrabold text-content-default mb-2 text-center">{{ title }}</h1>

  {{ content | safe }}

  <div x-data="connexionForm()" x-cloak class="p-8 bg-surface-subtle rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700">

    {# Step 1: Enter 3-word username #}
    <div x-show="step === 1">
      <label class="block text-sm font-bold text-content-default mb-2">Ton nom d'animal</label>
      <input
        type="text"
        x-model="username"
        @keydown.enter="findPupils()"
        placeholder="petit-renard-roux"
        class="w-full px-4 py-3 text-lg border-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors
          bg-surface-default text-content-default border-slate-200 dark:border-slate-700"
      />
      <div x-show="error" class="mt-3 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm" x-text="error"></div>
      <button
        @click="findPupils()"
        :disabled="!username.trim() || loading"
        class="mt-4 w-full px-6 py-3 bg-primary-500 text-white font-bold rounded-xl hover:bg-primary-600 shadow-md transition-all active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
      >
        <span x-show="loading" class="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></span>
        Suivant
      </button>
    </div>

    {# Step 2: Choose sticker #}
    <div x-show="step === 2">
      <h2 class="text-lg font-bold text-content-default mb-2 text-center">Quel est ton autocollant ?</h2>
      <p class="text-center text-content-subtle mb-6 text-sm" x-text="username"></p>

      <div class="grid grid-cols-4 gap-3 mb-6">
        <template x-for="pupil in matchingPupils" :key="pupil.id">
          <button
            @click="selectPupil(pupil)"
            class="aspect-square flex items-center justify-center text-4xl border-2 rounded-xl hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all active:scale-90
              border-slate-200 dark:border-slate-700"
            x-text="pupil.sticker_id"
          ></button>
        </template>
      </div>

      <button @click="step = 1; error = ''" class="w-full px-5 py-3 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-surface-subtle transition-colors">Retour</button>
    </div>

    {# Step 3: Visual password #}
    <div x-show="step === 3">
      <p class="text-center text-content-subtle mb-6">Entre ta cl√© secr√®te (3 images).</p>

      <div class="flex justify-center gap-4 mb-6">
        <template x-for="i in 3">
          <div
            class="w-14 h-14 border-2 border-dashed rounded-xl flex items-center justify-center text-2xl transition-all cursor-pointer"
            :class="passwordSequence[i-1] ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20 scale-110' : 'border-slate-300 dark:border-slate-600'"
            x-text="passwordSequence[i-1] || '?'"
            @click="removeLastIcon(i-1)"
          ></div>
        </template>
      </div>

      <div class="grid grid-cols-5 gap-3 mb-6">
        <template x-for="icon in icons" :key="icon">
          <button
            @click="addIcon(icon)"
            :disabled="passwordSequence.length >= 3"
            class="aspect-square flex items-center justify-center text-2xl border border-slate-100 dark:border-slate-700 rounded-xl hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all disabled:opacity-30 disabled:cursor-not-allowed active:scale-90"
            x-text="icon"
          ></button>
        </template>
      </div>

      <div x-show="error" class="mb-4 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm" x-text="error"></div>

      <div class="flex gap-3">
        <button @click="goBackFromPassword()" class="px-5 py-3 border border-slate-300 dark:border-slate-600 rounded-xl hover:bg-surface-subtle transition-colors">Retour</button>
        <button
          @click="verify()"
          :disabled="passwordSequence.length < 3 || loading"
          class="flex-1 px-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-md transition-all active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
        >
          <span x-show="loading" class="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></span>
          Se connecter
        </button>
      </div>
    </div>

    {# Step 4: Success #}
    <div x-show="step === 4" class="text-center py-4">
      <div class="text-6xl mb-4">üëã</div>
      <h2 class="text-2xl font-bold text-content-default mb-2">Content de te revoir !</h2>
      <p class="text-content-subtle mb-6" x-text="pupilRecord.username"></p>
      <a :href="'/cahier/' + pupilRecord.slug" class="inline-block px-8 py-3 bg-primary-500 text-white font-bold rounded-xl shadow-md hover:bg-primary-600 transition-all active:scale-95">
        Acc√©der √† mon cahier
      </a>
    </div>
  </div>

  <p class="text-center mt-6 text-sm text-content-subtle">
    Pas encore inscrit ? <a href="/fr/onboarding/" class="text-primary-500 hover:underline">Cr√©e ton identit√©</a>
  </p>
</div>

<script>
function connexionForm() {
  const pb = new PocketBase('{{ pocketbase.url }}');
  const demoStickers = ['üåª', 'üç¨', 'üåµ', 'üéà', 'üé®', 'üöÄ'];
  return {
    step: 1,
    demoMode: false,
    username: '',
    matchingPupils: [],
    passwordSequence: [],
    icons: ['üçé', 'üçå', 'üçí', 'üçì', 'üçá', 'üçç', 'üçë', 'üçê', 'üçâ', 'üçã'],
    error: '',
    loading: false,
    pupilRecord: null,

    async findPupils() {
      this.error = '';
      this.loading = true;
      const live = await window.__pbAvailable;
      if (!live) {
        this.demoMode = true;
        const name = this.username.trim() || 'petit-renard-roux';
        this.matchingPupils = demoStickers.slice(0, 3).map((s, i) => ({
          id: 'demo-' + i, username: name, sticker_id: s,
          visual_key: 'demo', slug: name + '-' + i
        }));
        this.loading = false;
        this.step = 2;
        return;
      }
      try {
        const res = await pb.collection('pupils').getFullList({
          filter: `username = "${this.username.trim()}"`
        });
        if (res.length === 0) {
          this.error = 'Pseudonyme introuvable. V√©rifie l\u2019orthographe.';
        } else if (res.length === 1) {
          this.pupilRecord = res[0];
          this.step = 3;
        } else {
          this.matchingPupils = res;
          this.step = 2;
        }
      } catch (err) {
        this.error = 'Erreur de connexion au serveur.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    selectPupil(pupil) {
      this.pupilRecord = pupil;
      this.step = 3;
    },

    goBackFromPassword() {
      this.error = '';
      this.passwordSequence = [];
      this.step = this.matchingPupils.length > 1 ? 2 : 1;
    },

    addIcon(icon) {
      if (this.passwordSequence.length < 3) this.passwordSequence.push(icon);
    },

    removeLastIcon(index) {
      if (index === this.passwordSequence.length - 1) this.passwordSequence.pop();
    },

    async verify() {
      this.error = '';
      this.loading = true;
      try {
        if (this.demoMode) {
          this.step = 4;
          return;
        }
        const entered = this.passwordSequence.join('-');
        if (entered === this.pupilRecord.visual_key) {
          this.step = 4;
        } else {
          this.error = 'Cl√© secr√®te incorrecte. Essaie encore.';
          this.passwordSequence = [];
        }
      } catch (err) {
        this.error = 'Erreur de v√©rification.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    }
  };
}
</script>
